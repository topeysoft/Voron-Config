"use strict";(globalThis["webpackChunkfrontend"]=globalThis["webpackChunkfrontend"]||[]).push([[593],{6593:(e,t,s)=>{s.r(t),s.d(t,{default:()=>Xe});var a=s(3673),i=s(2323);const r=(0,a._)("h1",{class:"q-ma-none m-0 p-0"},"Over-The-Air Software Update",-1),l={key:0,class:"row mxw-40em mb-3"},n=(0,a._)("p",null,[(0,a.Uk)(" This page will allow you to update the firmware of the base station. You can find the latest firmware update package for your device on our software repository "),(0,a._)("a",{class:"text-primary",target:"_blank",href:"//elyir.com/software"},"here"),(0,a.Uk)(". ")],-1),o=[n],d={class:"row"},c={class:"col-12 pt-2 p-centered",key:"error"},p={class:"col"},u={style:{"vertical-align":"middle"},class:"text-2"},m=(0,a._)("br",null,null,-1),f=(0,a._)("br",null,null,-1),h={class:"mt-3"},g=(0,a.Uk)("   Cancel "),w=(0,a.Uk)("   Retry "),_={class:"col-12 p-centered",key:"success"},v={class:"col"},k={style:{"vertical-align":"middle"},class:"text-2"},y=(0,a.Uk)(" Device was successfully updated "),b={class:"q-mt-md text-left self-end"},S=(0,a.Uk)(" Updated version: "),I={class:"faded"},T={class:"faded"},q=(0,a._)("br",null,null,-1),A=(0,a._)("br",null,null,-1),U={class:""},O=(0,a.Uk)(" Back "),x=(0,a.Uk)(" Reload Application "),D=(0,a.Uk)("Use this to refresh the UI if there are changes to the UI in the update"),C={class:"col-12 p-centered",key:"otainput"},E={class:"col mxw-50em"},F={class:"form-group"},z={class:"row mxw-40em"},M=(0,a.Uk)("Select package file "),P=(0,a._)("p",null," Please select the firmware update package you would like to install. You can also drag and drop the file onto the component. ",-1),W={key:0},R={key:0,class:"pt-2"},Z=(0,a._)("div",{class:"text-2"},"Package Manifest",-1),Q={class:"row"},Y={class:"col mb-1"},j={class:"q-mb-xs"},L=(0,a._)("span",{class:"faded"},"Package Name: ",-1),V={class:"q-mb-xs"},H=(0,a._)("span",{class:"faded"},"Package Description: ",-1),B={class:"q-mb-xs"},$=(0,a._)("span",{class:"faded"},"Package Build Date: ",-1),N={class:"row"},X={class:"col mb-1"},J=(0,a._)("div",{class:"text-1"},"Firmware Information",-1),K={class:"q-mb-xs"},G=(0,a._)("span",{class:"faded"},"Version: ",-1),ee={class:"q-mb-xs"},te=(0,a._)("span",{class:"faded"},"MD5 checksum: ",-1),se={class:"row"},ae={class:"col mb-1"},ie=(0,a._)("div",{class:"text-1"},"File System Information",-1),re={class:"q-mb-xs"},le=(0,a._)("span",{class:"faded"},"Version: ",-1),ne={class:"q-mb-xs"},oe=(0,a._)("span",{class:"faded"}," MD5 checksum: ",-1),de={key:1,class:"pt-2"},ce={class:"pb-1"},pe=(0,a._)("span",{class:"text-negative"}," Package verification failed!",-1),ue=(0,a.Uk)(),me=(0,a._)("br",null,null,-1),fe=(0,a.Uk)(" This package is not valid. Please check the package and try again. "),he=(0,a._)("div",null,null,-1),ge={class:"row mnw-45em"},we={key:0,class:"col-12"},_e={class:"q-pa-md"},ve={class:"row mb-2"},ke=(0,a._)("div",{class:"text-2"},"Device Update In Progress",-1),ye={class:"col-12"},be=(0,a.Uk)("Please do not refresh or navigate away from this page until this processes are completed. Doing so may cause the device to become unresponsive. ");function Se(e,t,s,n,Se,Ie){const Te=(0,a.up)("q-icon"),qe=(0,a.up)("q-btn"),Ae=(0,a.up)("tooltip"),Ue=(0,a.up)("q-label"),Oe=(0,a.up)("q-file"),xe=(0,a.up)("ota-upload-stage-item"),De=(0,a.up)("q-list"),Ce=(0,a.up)("q-card-section"),Ee=(0,a.up)("q-card"),Fe=(0,a.up)("q-page");return(0,a.wg)(),(0,a.j4)(Fe,{class:"p-2"},{default:(0,a.w5)((()=>[(0,a.Wm)(Ee,null,{default:(0,a.w5)((()=>[(0,a.Wm)(Ce,{class:"pb-5"},{default:(0,a.w5)((()=>[r,e.uploading?(0,a.kq)("",!0):((0,a.wg)(),(0,a.iD)("div",l,o)),(0,a._)("div",d,[e.loading||e.uploading||null===e.OTAError?e.loading||e.uploading||!e.OTASuccess?e.loading||e.uploading?(0,a.kq)("",!0):((0,a.wg)(),(0,a.iD)("div",C,[(0,a._)("div",E,[(0,a._)("div",F,[(0,a._)("div",z,[(0,a.Wm)(Ue,{class:"text-2 q-mb-sm"},{default:(0,a.w5)((()=>[M])),_:1}),P]),(0,a.Wm)(Oe,{modelValue:e.file,"onUpdate:modelValue":[t[0]||(t[0]=t=>e.file=t),e.readPackage],label:"Select File",outlined:"",counter:"","use-chips":"",accept:".zip,.epkg,.efw",class:"mxw-30em",ref:"file"},{prepend:(0,a.w5)((()=>[e.file&&!e.verifying?((0,a.wg)(),(0,a.iD)(a.HY,{key:0},[e.packageIsVerified?((0,a.wg)(),(0,a.j4)(Te,{key:0,color:"positive",name:"verified"})):(0,a.kq)("",!0),e.packageIsVerified?(0,a.kq)("",!0):((0,a.wg)(),(0,a.j4)(Te,{key:1,color:"negative",name:"error"}))],64)):(0,a.kq)("",!0),(0,a.Wm)(Te,{name:"attach_file"})])),_:1},8,["modelValue","onUpdate:modelValue"])]),e.file&&!e.verifying?((0,a.wg)(),(0,a.iD)("div",W,[e.packageIsVerified?((0,a.wg)(),(0,a.iD)("div",R,[Z,(0,a._)("div",Q,[(0,a._)("div",Y,[(0,a._)("div",j,[L,(0,a._)("span",null,(0,i.zw)(e.manifest.name),1)]),(0,a._)("div",V,[H,(0,a._)("span",null,(0,i.zw)(e.manifest.description),1)]),(0,a._)("div",B,[$,(0,a._)("span",null,(0,i.zw)(e.$formatDate(e.manifest.build_date,"ddd, DD MMM YYYY hh:mm:ss A")),1)])])]),(0,a._)("div",N,[(0,a._)("div",X,[J,(0,a._)("div",K,[G,(0,a._)("span",null,(0,i.zw)(e.manifest.fw_version),1)]),(0,a._)("div",ee,[te,(0,a._)("span",null,(0,i.zw)(e.manifest.fw_hash),1)])])]),(0,a._)("div",se,[(0,a._)("div",ae,[ie,(0,a._)("div",re,[le,(0,a._)("span",null,(0,i.zw)(e.manifest.fs_version),1)]),(0,a._)("div",ne,[oe,(0,a._)("span",null,(0,i.zw)(e.manifest.fs_hash),1)])])]),(0,a.Wm)(qe,{color:"primary",class:"mt-3",onClick:e.beginUpdate,label:"Upload To Device And Reboot",disabled:!e.file},null,8,["onClick","disabled"])])):e.file?((0,a.wg)(),(0,a.iD)("div",de,[(0,a._)("div",ce,[(0,a.Wm)(Te,{color:"negative",size:"24px",name:"error"}),pe,ue,me,fe])])):(0,a.kq)("",!0)])):(0,a.kq)("",!0),he])])):((0,a.wg)(),(0,a.iD)("div",_,[(0,a._)("div",v,[(0,a._)("span",k,[(0,a.Wm)(Te,{size:"3rem",color:"positive",name:"verified"}),y]),(0,a._)("div",b,[S,(0,a._)("div",I," Firmware: "+(0,i.zw)(e.identity.fw_version),1),(0,a._)("div",T," File System: "+(0,i.zw)(e.identity.fs_version),1)]),q,A,(0,a._)("div",U,[(0,a.Wm)(qe,{class:"btn btn-primary mt-3",onClick:e.clear,color:"primary",icon:"arrow_back"},{default:(0,a.w5)((()=>[O])),_:1},8,["onClick"]),(0,a.Wm)(qe,{class:"btn btn-primary mt-3",onClick:e.reloadApp,color:"primary",icon:"refresh"},{default:(0,a.w5)((()=>[x,(0,a.Wm)(Ae,null,{default:(0,a.w5)((()=>[D])),_:1})])),_:1},8,["onClick"])])])])):((0,a.wg)(),(0,a.iD)("div",c,[(0,a._)("div",p,[(0,a._)("span",u,[(0,a.Wm)(Te,{name:"info",size:"1.5em",color:"negative",class:"q-mr-sm"}),(0,a.Uk)(" "+(0,i.zw)(e.OTAError),1)]),m,f,(0,a._)("div",h,[(0,a.Wm)(qe,{onClick:e.clear,color:"primary",icon:"arrow_back"},{default:(0,a.w5)((()=>[g])),_:1},8,["onClick"]),e.packageIsVerified?((0,a.wg)(),(0,a.j4)(qe,{key:0,icon:"refresh",class:"ml-5",onClick:e.retryOTA},{default:(0,a.w5)((()=>[w])),_:1},8,["onClick"])):(0,a.kq)("",!0)])])]))]),(0,a._)("div",ge,[!e.loading&&e.uploading?((0,a.wg)(),(0,a.iD)("div",we,[(0,a._)("div",_e,[(0,a._)("div",ve,[ke,(0,a._)("p",ye,[(0,a.Wm)(Te,{size:"1.5rem",color:"warning",name:"info",class:"mr-1"}),be])]),(0,a.Wm)(De,null,{default:(0,a.w5)((()=>[((0,a.wg)(!0),(0,a.iD)(a.HY,null,(0,a.Ko)(e.uploadStatusItems,((e,t)=>((0,a.wg)(),(0,a.j4)(xe,{key:"upload_status_item"+t,status:e.status,progress:e.progress,description:e.description,title:e.title},null,8,["status","progress","description","title"])))),128))])),_:1})])])):(0,a.kq)("",!0)])])),_:1})])),_:1})])),_:1})}s(9544);var Ie=s(741),Te=s(7252),qe=s(3559),Ae=s.n(qe);const Ue={class:"text-right"};function Oe(e,t,s,r,l,n){const o=(0,a.up)("q-icon"),d=(0,a.up)("q-spinner-ios"),c=(0,a.up)("q-item-section"),p=(0,a.up)("q-item-label"),u=(0,a.up)("q-linear-progress"),m=(0,a.up)("q-item");return(0,a.wg)(),(0,a.j4)(m,null,{default:(0,a.w5)((()=>[(0,a.Wm)(c,{avatar:""},{default:(0,a.w5)((()=>["done"===s.status?((0,a.wg)(),(0,a.j4)(o,{key:0,color:"positive",name:"task_alt"})):"processing"===s.status?((0,a.wg)(),(0,a.j4)(d,{key:1,color:"primary",size:"1.5em"})):((0,a.wg)(),(0,a.j4)(o,{key:2,color:"grey-4",name:"radio_button_unchecked"}))])),_:1}),(0,a.Wm)(c,null,{default:(0,a.w5)((()=>[(0,a.Wm)(p,null,{default:(0,a.w5)((()=>[(0,a._)("div",{class:(0,i.C_)(["text-1",{"text-primary":"processing"===s.status}])},(0,i.zw)(s.title),3)])),_:1}),(0,a.Wm)(p,{caption:"",lines:"2"},{default:(0,a.w5)((()=>[(0,a.Uk)((0,i.zw)(s.description),1)])),_:1}),(0,a.Wm)(p,null,{default:(0,a.w5)((()=>[(0,a.Wm)(u,{value:s.progress/100,class:"q-mt-md"},null,8,["value"]),(0,a._)("div",Ue,(0,i.zw)(s.progress)+"%",1)])),_:1})])),_:1})])),_:1})}const xe={name:"OTAUploadStageItem",props:["status","progress","title","description"],data(){return{loading:!0,statusInterval:null}}};var De=s(4260),Ce=s(3414),Ee=s(2035),Fe=s(4554),ze=s(8506),Me=s(2350),Pe=s(1598),We=s(7518),Re=s.n(We);const Ze=(0,De.Z)(xe,[["render",Oe]]),Qe=Ze;Re()(xe,"components",{QItem:Ce.Z,QItemSection:Ee.Z,QIcon:Fe.Z,QSpinnerIos:ze.Z,QItemLabel:Me.Z,QLinearProgress:Pe.Z});const Ye=(0,a.aZ)({components:{OtaUploadStageItem:Qe},name:"PageOta",data(){return{loading:!1,uploading:!1,progress:0,OTAError:null,OTASuccess:!1,file:null,type:"firmware",manifest:{},fwChecksum:"",calcFwChecksum:"",calcFsChecksum:"",firmware:null,fileSystem:null,verifying:!1,currentStage:"fw_upload",uploadStatusItems:{fw_upload:{title:"Updating device firmware",description:"In this stage, the device firmware will be updated to the selected firmware file.",status:"pending",progress:0},restart_after_fw:{title:"Awaiting device reboot",description:"In this stage, we will wait for the device to reboot after the firmware update is complete.",status:"pending",progress:0},fs_upload:{title:"Updating device file system",description:"In this stage, the device file system will be updated to the version in the selected package.",status:"pending",progress:0},restart_after_fs:{title:"Awaiting device reboot",description:"In this stage, we will wait for the device to reboot after the file system update is complete.",status:"pending",progress:0},updating_manifest:{title:"Updating device package manifest",description:"In this stage, the device package manifest will be updated to the version in the selected package.",status:"pending",progress:0}}}},computed:{...(0,Ie.Se)({identity:"devices/identity",accessToken:"user/accessToken"}),packageIsVerified(){return this.file&&!this.verifying&&(this.manifest||{}).fw_hash===this.calcFwChecksum&&(this.manifest||{}).fs_hash===this.calcFsChecksum}},methods:{...(0,Ie.nv)({getStatus:"devices/getStatus",getIdentity:"devices/getIdentity"}),fileMD5(e){return new Promise(((t,s)=>{const a=File.prototype.slice||File.prototype.mozSlice||File.prototype.webkitSlice,i=2097152,r=Math.ceil(e.size/i),l=new(Ae().ArrayBuffer),n=new FileReader;let o,d=0;n.onload=e=>{if(l.append(e.target.result),d+=1,d<r)o();else{const e=l.end();t(e)}},n.onerror=e=>{s(e)},o=()=>{const t=d*i,s=t+i>=e.size?e.size:t+i;n.readAsArrayBuffer(a.call(e,t,s))},o()}))},beginUpdate(){switch(this.uploading=!0,this.currentStage){case"fw_upload":this.uploadFirmware().then((()=>{this.currentStage="restart_after_fw",this.beginUpdate()})).catch((()=>{this.uploading=!1}));break;case"restart_after_fw":this.awaitReboot("fw",15).then((()=>{this.currentStage="fs_upload",this.beginUpdate()}));break;case"fs_upload":this.uploadFileSystem().then((()=>{this.currentStage="restart_after_fs",this.beginUpdate()})).catch((()=>{this.uploading=!1}));break;case"restart_after_fs":this.awaitReboot("fs",15).then((()=>{this.currentStage="updating_manifest",this.beginUpdate()}));break;case"updating_manifest":this.updateManifest().then((()=>{this.currentStage="fw_upload",this.uploading=!1,this.OTASuccess=!0})).catch((()=>{this.uploading=!1,this.OTAError="Failed to update manifest"}));break;default:this.uploading=!1,this.OTAError="Unknown stage"}},awaitReboot(e="fw",t=15){return new Promise(((s,a)=>{this.uploadStatusItems["restart_after_"+e].status="processing",this.uploadStatusItems["restart_after_"+e].progress=0;let i=setInterval((()=>{this.uploadStatusItems["restart_after_"+e].progress+=Math.round(100*t/(1e3*t)*100),this.uploadStatusItems["restart_after_"+e].progress>=100&&(clearInterval(i),this.uploadStatusItems["restart_after_"+e].progress=100,this.uploadStatusItems["restart_after_"+e].status="done",s())}),100*t)}))},updateManifest(){return this.uploadStatusItems["updating_manifest"].progress=0,new Promise(((e,t)=>{this.uploadStatusItems["updating_manifest"].status="processing",this.uploadStatusItems["updating_manifest"].progress=Math.floor(23*Math.random()+28);var s=new FormData;for(var a in this.manifest)s.append(a,this.manifest[a]);this.$axios.put("/api/update",s).then((()=>{this.uploadStatusItems["updating_manifest"].progress+=16,setTimeout((()=>{this.uploadStatusItems["updating_manifest"].progress+=20,this.getIdentity().finally((()=>{this.uploadStatusItems["updating_manifest"].progress=100,setTimeout((()=>{e()}),2e3)}))}),1e4)})).catch(t)}))},uploadFileSystem(){return new Promise(((e,t)=>{this.uploadStatusItems["fs_upload"].status="processing";const s=new FormData,a=new XMLHttpRequest;a.addEventListener("load",(()=>{200===a.status?(this.uploadStatusItems["fs_upload"].status="done",e()):401===a.status?(this.OTAError="You don't have the permission to perform this operation",t()):500!==a.status?(this.OTAError=`[HTTP ERROR] ${a.statusText}`,t()):(this.OTAError=a.responseText,t())})),a.addEventListener("error",(()=>{401===a.status?(this.OTAError="You don't have the permission to perform this operation",t()):(this.OTAError=a.responseText,t())})),a.upload.addEventListener("progress",(e=>{this.uploadStatusItems["fs_upload"].progress=Math.trunc(e.loaded/e.total*100)})),a.withCredentials=!0,s.append("MD5",this.calcFsChecksum),s.append("filesystem",this.fileSystem,"filesystem"),a.open("post","/api/update"),a.setRequestHeader("Authorization","Bearer "+this.accessToken),a.send(s)}))},uploadFirmware(){return new Promise(((e,t)=>{this.uploadStatusItems["fw_upload"].status="processing";const s=new FormData,a=new XMLHttpRequest;a.addEventListener("load",(()=>{200===a.status?(this.uploadStatusItems["fw_upload"].status="done",e()):401===a.status?(this.OTAError="You don't have the permission to perform this operation",t()):500!==a.status?(this.OTAError=`[HTTP ERROR] ${a.statusText}`,t()):(this.OTAError=a.responseText,t())})),a.addEventListener("error",(()=>{401===a.status?(this.OTAError="You don't have the permission to perform this operation",t()):(this.OTAError=a.responseText,t())})),a.upload.addEventListener("progress",(e=>{this.uploadStatusItems["fw_upload"].progress=Math.trunc(e.loaded/e.total*100)})),a.withCredentials=!0,s.append("MD5",this.calcFwChecksum),s.append("firmware",this.firmware,"firmware"),a.open("post","/api/update"),a.setRequestHeader("Authorization","Bearer "+this.accessToken),a.send(s)}))},retryOTA(){this.OTAError=null,this.OTASuccess=!1,this.beginUpdate()},reloadApp(){window.location.reload()},clear(){this.OTAError=null,this.OTASuccess=!1,this.uploading=!1,this.currentStage="fw_upload",Object.values(this.uploadStatusItems).forEach((e=>{e.status="pending",e.progress=0})),this.file=null},async readPackage(e){this.verifying=!0;const t=new Te.Mr(new Te.Nt(e)),s=await t.getEntries();try{const e=s.find((e=>"manifest.json"===e.filename));this.firmware=await s.find((e=>"firmware.bin"===e.filename)).getData(new Te.U5),this.fileSystem=await s.find((e=>"spiffs.bin"===e.filename)).getData(new Te.U5);const a=await e.getData(new Te.Ek);this.manifest=JSON.parse(a),this.calcFwChecksum=await this.fileMD5(this.firmware),this.calcFsChecksum=await this.fileMD5(this.fileSystem),t.close(),this.verifying=!1}catch(a){return this.firmware=null,this.fileSystem=null,this.calcFwChecksum=null,this.calcFsChecksum=null,this.file=null,console.error(a),void(this.OTAError="Invalid package file")}}},mounted(){}});var je=s(4379),Le=s(151),Ve=s(5589),He=s(8240),Be=s(1052),$e=s(7011);const Ne=(0,De.Z)(Ye,[["render",Se]]),Xe=Ne;Re()(Ye,"components",{QPage:je.Z,QCard:Le.Z,QCardSection:Ve.Z,QIcon:Fe.Z,QBtn:He.Z,QFile:Be.Z,QList:$e.Z})}}]);